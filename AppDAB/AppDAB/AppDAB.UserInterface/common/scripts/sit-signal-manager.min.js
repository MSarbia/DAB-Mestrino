/* SIMATIC IT Unified Architecture Foundation V2.0 | Copyright (C) Siemens AG 2017. All Rights Reserved. */
var SIT=SIT||{};SIT.SignalManagerPoolFactory=function(){function a(a){h=a}function b(a){var b=0;for(b=0;b<i.length;b++)if(i[b].channel.signalApp===a)return i[b];return null}function c(a){i=i.filter(function(b){return b.channel.signalApp!==a})}function d(a,d,e,f){var g=h.defer(),j=null,k=b(e),l="";return k?k.channel.init(a,d,e,f).then(function(){k.counter++,g.resolve(k.channel)},function(a){g.reject(a)}):(l=this._internal.createGUID(),j=new SIT.SignalsManager(h,l),i.push({channel:j,counter:1,ownerGuid:l}),j.init(a,d,e,f).then(function(){g.resolve(j)},function(a){c(e),g.reject(a)})),g.promise}function e(a){var d=b(a.signalApp);return d?(d.counter--,0===d.counter&&(d.channel.close(d.ownerGuid),c(a.signalApp)),d.counter):-1}function f(a){c(a.signalApp)}function g(){for(var a=[],b="0123456789abcdef",c=0;c<36;c++)a[c]=b.substr(Math.floor(16*Math.random()),1);return a[14]="4",a[19]=b.substr(3&a[19]|8,1),a[8]=a[13]=a[18]=a[23]="-",a.join("")}var h=null,i=[];return{init:a,openEndPointChannel:d,releaseEndPointChannel:e,removeFromPool:f,_internal:{createGUID:g}}}(),SIT.SignalsManager=function(a){function b(a){if(G=!0,window.removeEventListener("unload",b),F.isOpened){try{B.onclose=function(){},B.close(1e3),B=null}catch(a){throw a}F.isOpened=!1,F.isInitialized=!1}}function c(a){a?window.addEventListener("unload",b):window.removeEventListener("unload",b)}function d(b,c){var d=a.defer();return h(b,c).then(function(a){var b=JSON.parse(a);if(b&&b.Endpoints&&b.Endpoints.length>0){var c={mainAddress:b.Endpoints[0].SignalMainAddress};d.resolve(c)}else d.reject("Metadata endpoint not valid")},function(a){d.reject(a)}),d.promise}function e(b){var c=a.defer(),d="";return h(b).then(function(a){var b=JSON.parse(a);d=F.signalApp&&b.applicationSignalManagerUrls[F.signalApp]?b.applicationSignalManagerUrls[F.signalApp]:b.signalManagerApplicationUrl,c.resolve(d+"/metadata")},function(a){c.reject(a)}),c.promise}function f(b,c,d){var e=a.defer();try{var f=new XMLHttpRequest;if(f.open(b,c,!0),d&&Array.isArray(d))for(var g=0;g<d.length;g++)f.setRequestHeader(d[g].name,d[g].value);f.onload=function(a){4==f.readyState&&200==f.status?e.resolve(f.responseText):e.reject(f.status)},f.send(null)}catch(a){e.reject(a.description)}return e.promise}function g(a,b){return f("POST",a,b)}function h(a,b){return f("GET",a,b)}function i(b,c){var d=a.defer();return j(c).then(function(a){g(a.replace(new RegExp("Authorize$"),"Session"),[{name:"Authorization",value:b}]).then(function(){d.resolve()},function(a){d.reject(a)})},function(a){d.reject(a)}),d.promise}function j(b){var c=a.defer();return h(b).then(function(a){var b=JSON.parse(a);c.resolve(b.authorizationServiceUrl)},function(a){c.reject(a)}),c.promise}function k(a,b){var c=null;return a.some(function(a,d){var e=b(a,d);return e&&(c=a),e}),c}function l(a,b){return a.indexOf(b,a.length-b.length)!==-1}function m(a){return l(a,"/")||(a+="/"),a+="Metadata",h(a).then(function(a){return void 0===a?a:JSON.parse(a)})}function n(a){var b=a.Signals;if(void 0===b)return b;var c=a.Endpoints;if(void 0===c)return c;for(var d=[],e=0;e<b.length;e++){var f=b[e],g=f.EndpointName,h=k(c,function(a,b){return a.Name==g}),i={};i.Name=f.Name,i.DisplayName=f.DisplayName,i.Serializer=f.Serializer,i.SignalMainAddress=h.SignalMainAddress,i.SignalStreamAddress=h.SignalStreamAddress,i.ApiAddress=h.ApiAddress,d.push(i)}return d}function o(){return B.readyState}function p(a){if(F.inPool&&SIT.SignalManagerPoolFactory.removeFromPool(F),a&&a.code){F.options&&F.options.onConnectionError&&angular.isFunction(F.options.onConnectionError)&&F.options.onConnectionError({reason:a.reason,code:a.code});for(var b in D)D[b].onError({reason:a.reason,code:a.code})}}function q(){if(!F.isOpened){F.openDefer=a.defer(),F.isOpened=!0,F.clientId||(F.clientId=SIT.SignalManagerPoolFactory._internal.createGUID());(function(b,c,d,e,f,g){var h=a.defer(),i=null,j="";try{j=b,j+=l(j,"/")?c:"/"+c,i=new WebSocket(j,d),i.onmessage=e,i.onerror=f,i.onclose=p}catch(a){throw a}return i.onopen=function(){h.resolve(i)},h.promise})(F.mainAddress,F.clientId,A,t,r,F.close).then(function(a){var b=a;if(c(!0),1!=b.readyState)throw F.openDefer.reject("Connection Error"),"Connection Error";B=b},function(a){F.openDefer.reject("Connection Error: "+a)})}return F.openDefer.promise}function r(a){var b=-1,c=0,d={};try{d=JSON.parse(a),d.sid&&(b=d.sid)}catch(a){}F.options&&F.options.onConnectionError&&angular.isFunction(F.options.onConnectionError)&&F.options.onConnectionError(a);for(c in D)b!==-1&&c!=="s"+b||D[c].onError(a)}function s(a){var b=-1,c=0;try{a.sid&&(b=error.sid)}catch(a){}for(c in D)b!==-1&&c!=="s"+b||D[c].onCompleted(a);b!==-1?delete D["s"+b]:D={}}function t(a){var b=JSON.parse(a.data),c=null,d=0,e=-1,f={},g={};if("Ready"===b.M)b.Result?(F.isOpened=!0,F.openDefer.resolve()):(F.isOpened=!1,F.openDefer.reject(b.Reason));else if("SubscribeAck"===b.M){for(d=0;d<C.length;d++)if(b.FunctionalBlockClass===C[d].signal&&b.Filter==C[d].filter){e=d;break}e!==-1&&(c=C.splice(e,1),b.Result?(D["s"+b.SID]=c[0],b.subScriptionId=F.clientId+"."+b.SID,c[0].subscriptionDefer.resolve(b)):c[0].subscriptionDefer.reject(b.Reason))}else"UnsubscribeAck"===b.M?(f=E["s"+b.SID],f?(delete E["s"+b.SID],b.Result&&f.unsubscriptionDefer.resolve(b)):(f=D["s"+b.SID])&&delete D["s"+b.SID]):"OnCompleted"===b.M?s(b):b.d&&b.sid&&(g=D["s"+b.sid])&&(b.sid=F.clientId+"."+b.sid,g.onNext(b))}function u(a){F.isInitialized=!1,F.initDefer.reject(a)}function v(b,c,f,g){var h=null;if(F.signalApp=f,F.options=g,F.isInitialized){if(f!==this.signalApp)return h=a.defer(),h.reject("init app mistmatch"),h.promise}else F.endPoint=c,F.token=b,F.isInitialized=!0,F.initDefer=a.defer(),c&&""!==c?i(b,c).then(function(){e(c).then(function(a){d(a,[{name:"Authorization",value:b}]).then(function(a){var b="",c="";0===a.mainAddress.indexOf("/")&&(b="https:"===location.protocol?"wss://":"ws://",c=location.host),F.mainAddress=b+c+a.mainAddress,q().then(function(){F.initDefer.resolve()},u)},u)},u)},u):(F.isInitialized=!1,F.initDefer.reject("Config EndPoint Invalid"));return F.initDefer.promise}function w(){if(F.inPool&&(1!==arguments.length||F.poolGUID!==arguments[0]))return!1;if(!F.isOpened)return!1;c(!1);try{1===arguments.length?this.unsubscribeAll(arguments[0]):this.unsubscribeAll(),B.close(1e3),B=null}catch(a){throw a}return F.isOpened=!1,F.isInitialized=!1,!0}function x(b,c,d,e,f){var g=a.defer(),h={functionalBlockClass:b,M:"Subscribe",filter:c};return C.push({signal:b,filter:c,onNext:d,onError:e,onCompleted:f,subscriptionDefer:g}),B.send(JSON.stringify(h)),g.promise}function y(){var a=null,b={};if(F.inPool&&(1!==arguments.length||F.poolGUID!==arguments[0]))return!1;for(a in D)b={SID:a.substr(1),M:"Unsubscribe"},B.send(JSON.stringify(b));D={}}function z(b){var c=a.defer(),d=null,e=b.split(".")[1],f={};return d=D["s"+e],d?(d.unsubscriptionDefer=c,delete D["s"+e],E["s"+e]=d,f={SID:e,M:"Unsubscribe"},B.send(JSON.stringify(f))):c.reject("Unknow subscription Id"),c.promise}var A="v1s.signals.unified",B=null,C=[],D={},E={};this.clientId=null,this.initDefer=a.defer(),this.openDefer=a.defer(),this.isInitialized=!1,this.isOpened=!1,this.endPoint=null,this.token=null,this.mainAddress="",this.inPool=!1,this.poolGUID="",this.signalApp="";var F=this;2==arguments.length&&(this.inPool=!0,this.poolGUID=arguments[1]);var G=!1;return{init:v,close:w,subscribe:x,unsubscribeAll:y,unsubscribe:z,getMetadata:m,getSignals:n,getMainCnnState:o,get endPoint(){return F.endPoint},get signalApp(){return F.signalApp}}},SIT.SignalManager=function(a){function b(a){return function(b){b&&b.d&&b.d.forEach(function(b){a(b)})}}function c(a){return function(){f.isSubscribed=!1,a&&a()}}this.endPoint="",this.token="",this.signalList=[];var d=a;SIT.SignalManagerPoolFactory.init(a);var e=null;this.signalName="",this._onNext=null,this._onError=null,this._onCompleted=null,this.filter="",this.subscriptionId="";var f=this;return this.isSubscribed=!1,this.isOpen=!1,f.app="",this.clientId=SIT.SignalManagerPoolFactory._internal.createGUID(),this.init=function(a,b,c,g){if(!d)return!1;var h=d.defer();return f.app=c,f.options=g,e?h.reject("Object already initialized"):SIT.SignalManagerPoolFactory.openEndPointChannel(a,b,f.app,f.options).then(function(a){e=a,f.endPoint=b,h.resolve()},function(a){h.reject(a)}),h.promise},this.open=function(a,b,c,g,h,i){if(!d)return!1;f.signalName=a,f._onNext=b,f._onError=c,f._onCompleted=g,f.filter=i;var j=d.defer();return e?(j.resolve(),f.isOpen=!0):j.reject("Objecy not inizialized"),h&&this.subscribe(),j.promise},this.close=function(){e&&(SIT.SignalManagerPoolFactory.releaseEndPointChannel(e),f.isOpen=!0,e=null)},this.subscribe=function(a,g,h,i){var j=d.defer(),k=f.filter,l=g||f._onNext,m=h||f._onError,n=i||f._onComplete;return e?f.isSubscribed?j.reject("Object already subscribed"):(f.isSubscribed=!0,a&&a.length&&(k=a),e.subscribe(f.signalName,k,b(l),m,c(n)).then(function(a){f.subscriptionId=a.subScriptionId,j.resolve(a)},function(a){f.isSubscribed=!1,j.reject(a)})):j.reject("Objecy not inizialized"),j.promise},this.unsubscribe=function(){var a=d.defer();return e?f.isSubscribed?e.unsubscribe(f.subscriptionId).then(function(b){f.isSubscribed=!1,a.resolve(b)},function(b){a.reject(b)}):a.reject("No subscription subscribed available"):a.reject("Objecy not inizialized"),a.promise},this.getMetadata=function(){return e?e.getMetadata():null},this.getSignals=function(){return e?e.getSignals():null},this.getMainCnnState=function(){return e?e.getMainCnnState():null},this.getStreamCnnState=function(){return e?e.getMainCnnState():null},this},SIT.SignalManager2=function(a){function b(b,d,e){var f=a.defer();return d&&""!==d||f.reject("Config EndPoint Invalid"),J.app=e,x(b,d).then(function(){getMetadataEndpoint(d).then(function(a){c(a,[{name:"Authorization",value:b}]).then(function(a){var b="https:"===location.protocol?"wss://":"ws://",c=0===a.mainAddress.indexOf("/")?location.host:"",d=0===a.streamAddress.indexOf("/")?location.host:"";J.mainAddress=b+c+a.mainAddress,J.streamAddress=b+d+a.streamAddress,f.resolve()},function(a){f.reject(a)})},function(a){f.reject(a)})},function(a){f.reject(a)}),f.promise}function c(b,c){var d=a.defer();return w(b,c).then(function(a){var b=JSON.parse(a);if(b&&b.Endpoints&&b.Endpoints.length>0){var c={mainAddress:b.Endpoints[0].SignalMainAddress,streamAddress:b.Endpoints[0].SignalStreamAddress};d.resolve(c)}else d.reject("Metadata endpoint not valid")},function(a){d.reject(a)}),d.promise}function d(b){var c=a.defer();return w(b).then(function(a){var b=JSON.parse(a);c.resolve(b.authorizationServiceUrl)},function(a){c.reject(a)}),c.promise}function e(b,c,d,e,f,g){if(!J.isOpen){J.clientId=s(),J.signalName=b,C=c,D=d,E=e,J.filter=g,F=a.defer();var h=function(b,c,d,e,f,g){var h,i=a.defer();try{var j=b;j+=r(j,"/")?c:"/"+c,h=new WebSocket(j,d),h.onmessage=e,h.onerror=f,h.onclose=g}catch(a){throw a}return h.onopen=function(){i.resolve(h)},i.promise},i=h(J.mainAddress,J.clientId,I,n,l,J.close),j=h(J.streamAddress,J.clientId,I,m,k,J.close),o=a.all([i,j]).then(function(a){var b=a[0],c=a[1];if(1!=b.readyState||1!=c.readyState)throw"Connection Error";return A=b,B=c,F.promise});return f?o.then(function(){return J.subscribe(J.filter)}):o}}function f(){if(J.isOpen){try{A.close(1e3)}catch(a){throw a}try{B.close(1e3)}catch(a){throw a}J.isOpen=!1}}function g(a,b,c,d){if(!J.isSubscribed)return J.filter=a,i(A,J.signalName,J.filter)}function h(){if(J.isSubscribed)return j(A,J.signalName)}function i(b,c,d){G=a.defer();var e={functionalBlockClass:c,M:"Subscribe",filter:d};return b.send(JSON.stringify(e)),G.promise}function j(b,c,d){H=a.defer();var e={functionalBlockClass:c,M:"Unsubscribe"};return b.send(JSON.stringify(e)),H.promise}function k(a){D(a)}function l(a){D(a)}function m(a){if(J.isOpen){var b=JSON.parse(a.data);for(index=0;index<b.length;++index)C(b[index])}}function n(a){var b=JSON.parse(a.data);"Ready"==b.M&&void 0!==F&&(J.isOpen=!0,F.resolve()),"SubscribeAck"==b.M&&void 0!==G&&(J.isSubscribed=b.Result,G.resolve(b)),"UnsubscribeAck"==b.M&&void 0!==H&&(J.isSubscribed=!1,H.resolve(b)),"OnCompleted"==b.M&&(J.isSubscribed=!1,o())}function o(){E()}function p(a){return r(a,"/")||(a+="/"),a+="Metadata",w(a).then(function(a){return void 0===a?a:JSON.parse(a)})}function q(a){var b=a.Signals;if(void 0===b)return b;var c=a.Endpoints;if(void 0===c)return c;for(var d=[],e=0;e<b.length;e++){var f=b[e],g=f.EndpointName,h=t(c,function(a,b){return a.Name==g}),i={};i.Name=f.Name,i.DisplayName=f.DisplayName,i.Serializer=f.Serializer,i.SignalMainAddress=h.SignalMainAddress,i.SignalStreamAddress=h.SignalStreamAddress,i.ApiAddress=h.ApiAddress,d.push(i)}return d}function r(a,b){return a.indexOf(b,a.length-b.length)!==-1}function s(){for(var a=[],b="0123456789abcdef",c=0;c<36;c++)a[c]=b.substr(Math.floor(16*Math.random()),1);return a[14]="4",a[19]=b.substr(3&a[19]|8,1),a[8]=a[13]=a[18]=a[23]="-",a.join("")}function t(a,b){var c=null;return a.some(function(a,d){var e=b(a,d);return e&&(c=a),e}),c}function u(b,c,d){var e=a.defer();try{var f=new XMLHttpRequest;if(f.open(b,c,!0),d&&Array.isArray(d))for(var g=0;g<d.length;g++)f.setRequestHeader(d[g].name,d[g].value);f.onload=function(a){4==f.readyState&&200==f.status?e.resolve(f.responseText):e.reject(f.status)},f.send(null)}catch(a){e.reject(a.description)}return e.promise}function v(a,b){return u("POST",a,b)}function w(a,b){return u("GET",a,b)}function x(b,c){var e=a.defer();return d(c).then(function(a){v(a.replace(new RegExp("Authorize$"),"Session"),[{name:"Authorization",value:b}]).then(function(){e.resolve()},function(a){e.reject(a)})},function(a){e.reject(a)}),e.promise}function y(){return A.readyState}function z(){return B.readyState}this.clientId,this.signalName,this.filter,this.isOpen=!1,this.isSubscribed=!1;var A,B,C,D,E,F,G,H,I="v1.signals.unified";this.mainAddress,this.streamAddress;var J=this;J.app="",this.init=b,this.open=e,this.close=f,this.subscribe=g,this.unsubscribe=h,this.getMetadata=p,this.getSignals=q,this.getMainCnnState=y,this.getStreamCnnState=z};